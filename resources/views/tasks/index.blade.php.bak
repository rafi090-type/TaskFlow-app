<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}" class="h-full bg-gray-50">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">

    <title>My Tasks - Daily Task Manager</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.bunny.net">
    <link href="https://fonts.bunny.net/css?family=figtree:400,500,600&display=swap" rel="stylesheet" />
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <!-- Styles -->
    @vite(['resources/css/app.css', 'resources/js/app.js'])
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .task-item {
            transition: all 0.2s ease;
        }
        .task-item:hover {
            transform: translateX(5px);
        }
    </style>
</head>
<body class="h-full">
    <div class="min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">Daily Task Manager</h1>
                <div class="flex items-center space-x-4">
                    <a href="{{ route('tasks.statistics') }}" 
                       class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">
                        View Statistics
                    </a>
                    <form method="POST" action="{{ route('logout') }}">
                        @csrf
                        <button type="submit" 
                                class="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">
                            Logout
                        </button>
                    </form>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Tasks Card -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                            <i class="fas fa-tasks text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Tasks</p>
                            <p class="text-2xl font-semibold text-gray-900">{{ $totalTasks }}</p>
                        </div>
                    </div>
                </div>

                <!-- Completed Tasks Card -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                            <i class="fas fa-check-circle text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Completed</p>
                            <p class="text-2xl font-semibold text-gray-900">{{ $completedTasks }}</p>
                        </div>
                    </div>
                </div>

                <!-- Pending Tasks Card -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 mr-4">
                            <i class="fas fa-clock text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Pending</p>
                            <p class="text-2xl font-semibold text-gray-900">{{ $pendingTasks }}</p>
                        </div>
                    </div>
                </div>

                <!-- Completion Rate Card -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 text-purple-600 mr-4">
                            <i class="fas fa-chart-line text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Completion Rate</p>
                            <p class="text-2xl font-semibold text-gray-900">{{ $completionRate }}%</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Task Button and Form -->
            <div class="mb-8">
                <button onclick="document.getElementById('addTaskModal').classList.remove('hidden')" 
                        class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors mb-4">
                    <i class="fas fa-plus mr-2"></i> Add New Task
                </button>
            
            @if(session('success'))
                <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                    {{ session('success') }}
                </div>
            @endif
            
            @if(session('error'))
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                    {{ session('error') }}
                </div>
            @endif

            <!-- Add Task Modal -->
            <div id="addTaskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">Tambah Tugas Baru</h3>
                        <button type="button" class="text-gray-500 hover:text-gray-700" 
                                onclick="document.getElementById('addTaskModal').classList.add('hidden')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form action="{{ route('tasks.store') }}" method="POST" class="space-y-4">
                        @csrf
                        <div>
                            <label for="title" class="block text-gray-700 font-medium mb-2">Judul Tugas *</label>
                            <input type="text" id="title" name="title" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="description" class="block text-gray-700 font-medium mb-2">Deskripsi</label>
                            <textarea id="description" name="description" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="category" class="block text-gray-700 font-medium mb-2">Kategori</label>
                                <select id="category" name="category" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="work">üíº Pekerjaan</option>
                                    <option value="personal">‚ù§Ô∏è Pribadi</option>
                                    <option value="study">üìö Belajar</option>
                                    <option value="shopping">üõçÔ∏è Belanja</option>
                                    <option value="other">‚ú® Lainnya</option>
                                </select>
                            </div>
                            <div>
                                <label for="priority" class="block text-gray-700 font-medium mb-2">Prioritas</label>
                                <select id="priority" name="priority" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="low">Rendah</option>
                                    <option value="medium" selected>Sedang</option>
                                    <option value="high">Tinggi</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="due_date" class="block text-gray-700 font-medium mb-2">Tanggal Jatuh Tempo</label>
                            <input type="datetime-local" id="due_date" name="due_date"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" 
                                    class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
                                    onclick="document.getElementById('addTaskModal').classList.add('hidden')">
                                Batal
                            </button>
                            <button type="submit" 
                                    class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                                <i class="fas fa-plus mr-2"></i>Tambah Tugas
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            @if($errors->any())
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                    <ul class="list-disc list-inside">
                        @foreach($errors->all() as $error)
                            <li>{{ $error }}</li>
                        @endforeach
                    </ul>
                </div>
            @endif

            <!-- Daily Progress -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 mb-8 border border-blue-100">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üìä Progress Harian</h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <h3 class="text-lg font-medium text-gray-800">
                                Progress Hari Ini
                                @if(isset($todaysProgress) && $todaysProgress == 100)
                                    <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        Selesai Semua!
                                    </span>
                                @endif
                            </h3>
                            <p class="text-sm text-gray-600 mt-1">
                                {{ $todaysCompleted ?? 0 }} dari {{ $todaysTotal ?? 0 }} tugas selesai
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-600">Progress</p>
                            <p class="text-2xl font-bold text-green-600">{{ $todaysProgress ?? 0 }}<span class="text-sm text-gray-500">%</span></p>
                        </div>
                    </div>
                    
                    <!-- Animated Progress Bar -->
                    <div class="relative pt-1">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-200">
                                    {{ $todaysProgress }}% Complete
                                </span>
                            </div>
                        </div>
                        <div class="overflow-hidden h-4 mb-2 text-xs flex rounded-full bg-gray-200 mt-2">
                            @php
                                $progressColor = match(true) {
                                    $todaysProgress >= 75 => 'bg-gradient-to-r from-green-400 to-teal-500',
                                    $todaysProgress >= 50 => 'bg-gradient-to-r from-yellow-400 to-orange-500',
                                    $todaysProgress >= 25 => 'bg-gradient-to-r from-orange-400 to-pink-500',
                                    default => 'bg-gradient-to-r from-pink-400 to-red-500'
                                };
                            @endphp
                            <div style="width: {{ $todaysProgress }}%" 
                                 class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center transition-all duration-500 ease-in-out {{ $progressColor }}">
                            </div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-600">
                            <span>0%</span>
                            <span>50%</span>
                            <span>100%</span>
                        </div>
                    </div>
                    
                    @if($todaysTotal > 0)
                        <p class="text-sm text-center text-gray-500 mt-2">
                            @if($todaysProgress == 100)
                                üéâ Amazing! You've completed all tasks for today!
                            @elseif($todaysProgress >= 75)
                                üî• You're on fire! Almost there!
                            @elseif($todaysProgress >= 50)
                                üí™ Keep going! You're halfway there!
                            @elseif($todaysProgress > 0)
                                ‚ú® Good start! Every task counts!
                            @else
                                üöÄ Ready to start? Add your first task for today!
                            @endif
                        </p>
                    @else
                        <p class="text-sm text-center text-gray-500 mt-2">
                            No tasks added for today. Start by adding one above! üëÜ
                        </p>
                    @endif
                </div>
            </div>

            <!-- Add Task Form -->
            <form action="{{ route('tasks.store') }}" method="POST" class="mb-8">
                @csrf
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="title" class="block text-gray-700 font-medium mb-2">Judul Tugas *</label>
                        <input type="text" name="title" id="title" 
                            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Masukkan judul tugas" 
                            value="{{ old('title') }}"
                            required>
                    </div>
                    <div>
                        <label for="category" class="block text-gray-700 font-medium mb-2">Kategori *</label>
                        <select name="category" id="category" 
                            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="work" {{ old('category') == 'work' ? 'selected' : '' }}>üíº Pekerjaan</option>
                            <option value="personal" {{ old('category', 'personal') == 'personal' ? 'selected' : '' }}>‚ù§Ô∏è Pribadi</option>
                            <option value="study" {{ old('category') == 'study' ? 'selected' : '' }}>üìö Belajar</option>
                            <option value="shopping" {{ old('category') == 'shopping' ? 'selected' : '' }}>üõçÔ∏è Belanja</option>
                            <option value="other" {{ old('category') == 'other' ? 'selected' : '' }}>‚ú® Lainnya</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="description" class="block text-gray-700 font-medium mb-2">Deskripsi (Opsional)</label>
                    <textarea name="description" id="description" rows="2"
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Masukkan deskripsi tugas">{{ old('description') }}</textarea>
                </div>
                <div class="mb-4">
                    <label for="due_date" class="block text-gray-700 font-medium mb-2">Tanggal Jatuh Tempo (Opsional)</label>
                    <input type="datetime-local" name="due_date" id="due_date"
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value="{{ old('due_date') }}">
                </div>
                <div>
                    <label for="priority" class="block text-gray-700 font-medium mb-2">Prioritas *</label>
                    <select name="priority" id="priority" 
                            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="low" {{ old('priority') == 'low' ? 'selected' : '' }}>Rendah</option>
                        <option value="medium" {{ old('priority', 'medium') == 'medium' ? 'selected' : '' }}>Sedang</option>
                        <option value="high" {{ old('priority') == 'high' ? 'selected' : '' }}>Tinggi</option>
                    </select>
                </div>
                
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                    Tambah Tugas
                </button>

            </form>

            <!-- Motivational Quote -->
            <div class="mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-r">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">
                            {{ $randomQuote }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Tasks List -->
            @if($tasks->count() > 0)
                <div class="space-y-4">
                    @foreach($tasks as $task)
                        <div class="border-b pb-4 mb-4">
                            <div class="flex justify-between items-start">
                                <div class="flex-1 {{ $task->completed ? 'opacity-75' : '' }}">
                                    <div>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-lg font-medium {{ $task->completed ? 'line-through text-gray-400' : 'text-gray-800' }}">
                                                {{ $task->title }}
                                            </span>
                                            @php
                                                $categoryIcons = [
                                                    'work' => 'üíº',
                                                    'personal' => '‚ù§Ô∏è',
                                                    'study' => 'üìö',
                                                    'shopping' => 'üõçÔ∏è',
                                                    'other' => '‚ú®'
                                                ];
                                                $categoryNames = [
                                                    'work' => 'Work',
                                                    'personal' => 'Personal',
                                                    'study' => 'Study',
                                                    'shopping' => 'Shopping',
                                                    'other' => 'Other'
                                                ];
                                            @endphp
                                            <span class="text-sm px-2 py-0.5 rounded-full bg-gray-100 text-gray-600" 
                                                  title="{{ $categoryNames[$task->category] ?? 'Other' }}">
                                                {{ $categoryIcons[$task->category] ?? '‚ú®' }}
                                            </span>
                                            @if($task->priority === 'high')
                                                <span class="text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-800">
                                                    High Priority
                                                </span>
                                            @elseif($task->priority === 'medium')
                                                <span class="text-xs px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800">
                                                    Medium Priority
                                                </span>
                                            @else
                                                <span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-800">
                                                    Low Priority
                                                </span>
                                            @endif
                                        </div>
                                        @if($task->description)
                                            <p class="text-gray-600 mt-1">{{ $task->description }}</p>
                                        @endif
                                        @if($task->due_date)
                                            <p class="text-sm mt-1">
                                                <span class="text-gray-500">Due:</span>
                                                <span class="font-medium {{ $task->due_date->isPast() && !$task->completed ? 'text-red-500' : 'text-gray-600' }}">
                                                    {{ $task->due_date->format('M d, Y H:i') }}
                                                    @if($task->due_date->isPast() && !$task->completed)
                                                        <span class="text-red-500">(Overdue)</span>
                                                    @endif
                                                </span>
                                            </p>
                                        @endif
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <!-- Checkbox Completion -->
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" 
                                            class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 task-complete"
                                            data-task-id="{{ $task->id }}" 
                                            {{ $task->completed ? 'checked' : '' }}
                                            title="{{ $task->completed ? 'Tandai belum selesai' : 'Tandai selesai' }}">
                                    </label>
                                    
                                    <!-- Edit Button -->
                                    <button type="button" 
                                        class="text-blue-500 hover:text-blue-700 edit-task"
                                        data-task-id="{{ $task->id }}"
                                        data-title="{{ $task->title }}"
                                        data-description="{{ $task->description }}"
                                        data-category="{{ $task->category }}"
                                        data-priority="{{ $task->priority }}"
                                        data-due-date="{{ $task->due_date ? $task->due_date->format('Y-m-d\TH:i') : '' }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                        <form action="{{ route('tasks.destroy', $task) }}" method="POST" class="inline">
                                            @csrf
                                            @method('DELETE')
                                            <button type="submit" class="text-red-500 hover:text-red-700" onclick="return confirm('Apakah Anda yakin ingin menghapus tugas ini?')">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                        </form>
                                    </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    @endforeach
                </div>
            @else
                <p class="text-gray-500 text-center py-8">No tasks found. Add your first task above!</p>
            @endif
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="editTaskModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Edit Tugas</h3>
                <button type="button" class="text-gray-500 hover:text-gray-700" onclick="closeEditModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="editTaskForm" method="POST" class="space-y-4">
                @csrf
                @method('PUT')
                <div>
                    <label for="edit_title" class="block text-gray-700 font-medium mb-2">Judul Tugas *</label>
                    <input type="text" name="title" id="edit_title" 
                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Masukkan judul tugas" required>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit_category" class="block text-gray-700 font-medium mb-2">Kategori *</label>
                        <select name="category" id="edit_category" 
                                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="work">üíº Pekerjaan</option>
                            <option value="personal">‚ù§Ô∏è Pribadi</option>
                            <option value="study">üìö Belajar</option>
                            <option value="shopping">üõçÔ∏è Belanja</option>
                            <option value="other">‚ú® Lainnya</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit_priority" class="block text-gray-700 font-medium mb-2">Prioritas *</label>
                        <select name="priority" id="edit_priority" 
                                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="low">Rendah</option>
                            <option value="medium">Sedang</option>
                            <option value="high">Tinggi</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="edit_description" class="block text-gray-700 font-medium mb-2">Deskripsi (Opsional)</label>
                    <textarea name="description" id="edit_description" rows="3"
                              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Masukkan deskripsi tugas"></textarea>
                </div>
                <div>
                    <label for="edit_due_date" class="block text-gray-700 font-medium mb-2">Tanggal Jatuh Tempo (Opsional)</label>
                    <input type="datetime-local" name="due_date" id="edit_due_date"
                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="pt-4 space-y-4">
                    <!-- Completion Status Toggle -->
                    <div class="flex items-center">
                        <span class="text-gray-700 font-medium mr-3">Status:</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" name="completed" id="edit_completed" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            <span class="ml-2 text-sm font-medium text-gray-700" id="status-text">Belum Selesai</span>
                        </label>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex justify-end space-x-3 pt-2">
                        <button type="button" onclick="closeEditModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Batal
                        </button>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                            Perbarui Tugas
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let editTaskModal, editTaskForm, currentTaskId = null;

        // Initialize modal when the page loads
        function initEditModal() {
            // Get elements
            editTaskModal = document.getElementById('editTaskModal');
            editTaskForm = document.getElementById('editTaskForm');
            
            if (!editTaskModal || !editTaskForm) {
                console.error('Modal elements not found');
                return;
            }

            // Close modal when clicking outside
            editTaskModal.addEventListener('click', function(e) {
                if (e.target === editTaskModal) {
                    closeEditModal();
                }
            });

            // Toggle task completion
            document.addEventListener('change', async function(e) {
                if (!e.target.matches('.task-complete')) return;
                
                const checkbox = e.target;
                const taskId = checkbox.dataset.taskId;
                const isCompleted = checkbox.checked;
                const taskItem = checkbox.closest('.border-b');
                
                // Find the title element more reliably
                const taskTitle = taskItem ? taskItem.querySelector('.text-lg.font-medium') : null;
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
                
                if (!taskId || !taskItem || !csrfToken) {
                    console.error('Required elements not found');
                    checkbox.checked = !isCompleted; // Revert checkbox state
                    return;
                }

                // Show loading state
                checkbox.disabled = true;
                
                try {
                    // Convert boolean to string to ensure proper form data handling
                    const formData = new FormData();
                    formData.append('_method', 'PATCH');
                    formData.append('completed', isCompleted.toString());
                    
                    const response = await fetch(`/tasks/${taskId}/toggle`, {
                        method: 'POST',
                        headers: {
                            'X-CSRF-TOKEN': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        },
                        body: formData
                    });

                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'Gagal memperbarui status tugas');
                    }

                    // Toggle the completed class on the task item
                    taskItem.classList.toggle('opacity-75', isCompleted);
                    
                    // Only try to update title if it exists
                    if (taskTitle) {
                        taskTitle.classList.toggle('line-through', isCompleted);
                        taskTitle.classList.toggle('text-gray-400', isCompleted);
                        taskTitle.classList.toggle('text-gray-800', !isCompleted);
                    }

                    showToast(
                        isCompleted ? 'Tugas berhasil ditandai selesai!' : 'Tugas ditandai belum selesai',
                        'success'
                    );

                    // Update statistics
                    updateTaskStatistics();

                } catch (error) {
                    console.error('Error:', error);
                    checkbox.checked = !isCompleted; // Revert checkbox if error
                    showToast(
                        error.message || 'Gagal memperbarui status tugas', 
                        'error'
                    );
                } finally {
                    checkbox.disabled = false;
                }
            });

            // Handle click events for edit buttons and modals
            document.addEventListener('click', function(e) {
                // Handle edit button click
                const editButton = e.target.closest('.edit-task');
                if (editButton) {
                    e.preventDefault();
                    openEditModal(editButton);
                    return;
                }

                // Close modal when clicking outside or cancel button
                if (e.target.matches('.cancel-edit, #editTaskModal')) {
                    closeEditModal();
                }
            });

            // Handle edit form submission
            editTaskForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!currentTaskId) return;
                
                const formData = new FormData(this);
                const submitButton = this.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                
                // Show loading state
                submitButton.disabled = true;
                submitButton.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Menyimpan...';
                
                try {
                    // Add _method for Laravel's form method spoofing
                    formData.append('_method', 'PUT');
                    
                    const response = await fetch(this.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'Gagal memperbarui tugas');
                    }
                    
                    if (data.success) {
                        // Close modal and show success message
                        closeEditModal();
                        showToast('Tugas berhasil diperbarui', 'success');
                        
                        // Refresh the page to show updated data
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        throw new Error(data.message || 'Gagal memperbarui tugas');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showToast(error.message || 'Terjadi kesalahan saat memperbarui tugas', 'error');
                } finally {
                    // Reset button state
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Perbarui Tugas';
                }
            });

            // Handle delete button clicks
            document.addEventListener('click', function(e) {
                if (e.target.matches('.delete-task') || e.target.closest('.delete-task')) {
                    e.preventDefault();
                    const button = e.target.matches('.delete-task') ? e.target : e.target.closest('.delete-task');
                    const taskId = button.dataset.taskId;
                    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                    
                    if (confirm('Apakah Anda yakin ingin menghapus tugas ini?')) {
                        fetch(`/tasks/${taskId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': csrfToken,
                                'Accept': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-HTTP-Method-Override': 'DELETE'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Reload the page to see changes
                                window.location.reload();
                            } else {
                                alert('Gagal menghapus tugas. ' + (data.message || ''));
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Terjadi kesalahan saat menghapus tugas. Silakan coba lagi.');
                        });
                    }
                }
            });
        }

        // Function to open edit modal
        function openEditModal(button) {
            currentTaskId = button.dataset.taskId;
            
            // Set form action with task ID
            const formAction = `/tasks/${currentTaskId}`;
            editTaskForm.action = formAction;

            // Reset form
            editTaskForm.reset();

            // Get task item container
            const taskItem = button.closest('.border-b');
            if (!taskItem) {
                console.error('Task item not found');
                return;
            }

            // Get completion status from the checkbox in the task item
            const isCompleted = taskItem.querySelector('.task-complete')?.checked || false;

            // Set form values from data attributes
            document.getElementById('edit_title').value = button.dataset.title || '';
            document.getElementById('edit_description').value = button.dataset.description || '';
            document.getElementById('edit_category').value = button.dataset.category || 'work';
            document.getElementById('edit_priority').value = button.dataset.priority || 'medium';
            
            // Set due date if it exists
            if (button.dataset.dueDate) {
                document.getElementById('edit_due_date').value = button.dataset.dueDate;
            }

            // Set completion status
            const completedCheckbox = document.getElementById('edit_completed');
            const statusText = document.getElementById('status-text');
            if (completedCheckbox) {
                completedCheckbox.checked = isCompleted;
                if (statusText) {
                    statusText.textContent = isCompleted ? 'Selesai' : 'Belum Selesai';
                }
            }

            // Show the modal with animation
            editTaskModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            setTimeout(() => {
                editTaskModal.classList.add('opacity-100');
            }, 10);
        }

        // Function to close edit modal
        function closeEditModal() {
            if (editTaskModal) {
                editTaskModal.classList.remove('opacity-100');
                setTimeout(() => {
                    editTaskModal.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                    currentTaskId = null;
                }, 300);
            }
        }

        // Function to show toast notification
        function showToast(message, type = 'success') {
            // Create toast element if it doesn't exist
            let toast = document.getElementById('toast-notification');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast-notification';
                toast.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white transition-all duration-300 transform translate-y-10 opacity-0';
                document.body.appendChild(toast);
            }

            // Set toast content and style based on type
            toast.textContent = message;
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white transition-all duration-300 transform ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } translate-y-10 opacity-0`;

            // Show toast
            setTimeout(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
                toast.classList.add('translate-y-0', 'opacity-100');
                
                // Hide after 3 seconds
                setTimeout(() => {
                    toast.classList.add('opacity-0');
                    setTimeout(() => {
                        toast.classList.add('translate-y-10');
                    }, 300);
                }, 3000);
            }, 100);
        }

        // Initialize the modal when the DOM is fully loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initEditModal);
        } else {
            // DOM is already loaded
            initEditModal();
        }
    </script>
    
    <script>
        // Function to update task statistics
        async function updateTaskStatistics() {
            try {
                const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                const response = await fetch('{{ route("tasks.statistics") }}', {
                    headers: {
                        'X-CSRF-TOKEN': csrfToken,
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                
                // Update the progress display
                const progressElement = document.querySelector('.progress-bar');
                const progressText = document.querySelector('.progress-percentage');
                const completedCount = document.getElementById('completed-count');
                const totalCount = document.getElementById('total-count');
                
                if (progressElement) progressElement.style.width = `${data.completionRate}%`;
                if (progressText) progressText.textContent = `${Math.round(data.completionRate)}%`;
                if (completedCount) completedCount.textContent = data.completedTasks;
                if (totalCount) totalCount.textContent = data.totalTasks;
                
            } catch (error) {
                console.error('Error updating statistics:', error);
            }
        }
    </script>
</body>
</html>
